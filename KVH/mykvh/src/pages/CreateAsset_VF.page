<apex:page Controller="CreateAsset_Class" sidebar="false">
    <script src="/soap/ajax/20.0/connection.js" type="text/javascript"></script>
    <script src="/soap/ajax/15.0/apex.js" type="text/javascript"></script> 
     <apex:includeScript value="{!$Resource.CreateAsset_VFJQ2}"/>
     <apex:includeScript value="{!$Resource.CreateAsset_VFJQ1}"/>
     <apex:stylesheet value="{!URLFOR($Resource.CreateAsset_VFJQ3)}"/>
     
      <script>
           window.onload = function() {
              var prdCode = "{!itemNumber}";
              findProductCode(prdCode);
           };
           
           sforce.connection.sessionId = "{!$Api.Session_ID}";
           var temparray;
           var jqueryFunction;
           
           var availableProds = '[';
              function findProductCode(pc){
                  result = sforce.connection.query("Select Name,Id,ProductCode from Product2 WHERE isActive=true AND Product_ID__c LIKE '%_US' AND Product_ID__c LIKE '" + pc + "%'  LIMIT 10");
                  records = result.getArray("records");
                  if(records.length > 0){
                       temparray =new Array();
                       var map;
                       for (var i=0;i<records.length;i++){
                            map = new Object();
                            map['label'] = records[i].ProductCode;
                            map['value'] = records[i].Id;
                            availableProds += '"'+records[i].ProductCode+'",'; 
                            //temparray.push(records[i].Product_ID__c);
                            temparray.push(map);
                       }
                       availableProds += ']';
                       initiatAutocomplete(temparray);
                  }
               }
          var selectedProductID;
          function initiatAutocomplete(temparray){
                  console.log('temparray: ' +temparray);
                $(function() {         
                $( "input[id*='tags']").autocomplete({
                  source: temparray,
                  focus: function( event, ui ) {
                      $( "input[id*='tags']").val( ui.item.label );
                      selectedProductID = ui.item.value;
                      return false;
                  },
                  select: function( event, ui ) {
                        $( "input[id*='tags']").val( ui.item.label );
                        selectedProductID = ui.item.value;
                        return false;
                   }
                });
              });
          }       
           function ErrorMessage(){
              var test = document.getElementsByClassName('Message');
              var im = document.getElementsByClassName('itemNumber');
              if((test.length > 0 && test[0].value == '') || (im.length>0 && im[0].value == '')){
                  alert('Please Provide Serial Number & Item Number');
              }else{
                  var isFound = false;
                  
                  for (i = 0; i < temparray.length; i++) {
                       console.log(temparray[i]['label']);
                       console.log(im[0].value);
                       if(temparray[i]['label'] == im[0].value){
                           isFound = true;
                       }
                   }
                  if(isFound){
                      callCreateAssetMethod(selectedProductID);
                  }else{
                      alert('Item Number not found OR Selected Product InActive');
                  }
              }
          } 
          
          function callCancelFunction(){
              var assetID = "{!assetid}";
              var productID = "{!productid}";
              if(assetID!=null && assetID!=''){
                  window.location="/{!assetid}";
              } 
              else if(productID!=null && productID!='') {
                  window.location="/{!productID}";
              }
              
          }  
      </script>
    
  <apex:form id="frmid">
    <apex:actionFunction name="callCreateAssetMethod" action="{!createAsset}" reRender="frmid" status="status">
        <apex:param id="anode" name="node" value=""/>
    </apex:actionFunction>
    <apex:pageMessages escape="false"></apex:pageMessages>
    <apex:actionstatus id="status">
        <apex:facet name="start">
            <div class="waitingSearchDiv" id="el_loading" style="background-color: #fbfbfb; height:100%;opacity:0.65;width:100%;">
                <div class="waitingHolder" style="margin-left: 30%;position: fixed;">
                <img class="waitingImage" src="/img/loading.gif" title="Please Wait..." />
                <span class="waitingDescription">Loading...</span>
                </div>
            </div>
        </apex:facet>
    </apex:actionstatus>
    <apex:pageBlock >    
        <apex:pageBlockSection title="Create Asset" columns="1">
            <apex:inputText id="tags" label="Item Number" value="{!itemNumber}" styleClass="itemNumber" onkeyup="findProductCode(this.value); return false;"/> 
            <apex:inputText label="Serial Number" value="{!sequenceName}" required="true" styleClass="Message"/>                         
            <apex:inputText label="Sequence" value="{!sequenceNumber}"/> 
        </apex:pageBlockSection>
        <apex:pageBlockButtons location="bottom">
            <apex:commandButton value="Submit" onclick="ErrorMessage(); return false;" reRender="frmid"/>
            <apex:commandButton value="Cancel" onclick="callCancelFunction(); return false;" immediate="true" />    
        </apex:pageBlockButtons>                         
    </apex:pageBlock>
    
  </apex:form>
</apex:page>