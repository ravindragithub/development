<apex:page standardcontroller="ortoo_e2a__Queued_Email_Message__c"  id="page" extensions="ortoo_e2a.UnmatchedEmailDetail">
<style>
    .inputField
    {
        width: 80%;
    }
    .wrapText
    {
    white-space: pre-wrap; /* css-3 */
    white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
    white-space: -pre-wrap; /* Opera 4-6 */
    white-space: -o-pre-wrap; /* Opera 7 */
    word-wrap: break-word; /* Internet Explorer 5.5+ */
     
    }
    .dont-break-out 
    {

    /* These are technically the same, but use both */
        overflow-wrap: break-word;
        word-wrap: break-word;

        -ms-word-break: break-all;
        /* This is the dangerous one in WebKit, as it breaks things wherever */
        word-break: break-all;
        /* Instead use this non-standard one: */
        word-break: break-word;

        /* Adds a hyphen where the word breaks, if supported (No Blink) */
        -ms-hyphens: auto;
        -moz-hyphens: auto;
        -webkit-hyphens: auto;
        hyphens: auto;

    } 
</style>
<script type="text/javascript">


    function init() 
    {   
        var editor_instance = document.getElementById('{!$Component.page.UnmatchedEmailDetail.pb_view.EmailInformation.HtmlBodyView.HtmlBodyId}');
        console.log(editor_instance);
        if(editor_instance != null)
        {
            if({!JSENCODE(HtmlBody) != null})
            {       
                editor_instance.innerHTML = tidyHtml('{!JSENCODE(HtmlBody)}');
            }

        }
        
    } 
  
    
    //Tidy Html
    //I have call it on id HtmlBodyViewId by removing previous dynamic component
    
    function tidyHtml(html) 
    {
        var html = html.trim().replace(/>[^<]+</gm, function ($1) {
            return '>' + $1.substr(1, $1.length - 2).trim() + '<';
        }).replace(/>\s+</gm, '><');
        var containerElement = document.createElement('div');
        containerElement.innerHTML = html;
        var result = containerElement.innerHTML;
        
        return result;
    }
    
 document.addEventListener('DOMContentLoaded', init, false);   
</script> 
<script src="/soap/ajax/17.0/connection.js" type="text/javascript"></script>
<script type="text/javascript">
    window.onload = function() 
    {
        sforce.connection.sessionId = '{!$Api.Session_ID}';
        document.getElementById('{!$Component.page.UnmatchedEmailDetail.thepb.pbs.pbSI_body.editor_panel}').style.display='';
    }
</script>

<script>
   function switchMailAlert()
   {
       if (!window.confirm('All changes and formattings will be removed.\n\nAre you sure?'))
       {
           return false;
       }
       else
       {
           return true;
       }
   }
</script>

<script type="text/javascript" src="{!URLFOR($Resource.tinymce,'tinymce/tinymce.min.js')}"></script>
<!-- <script type="text/javascript" src="{!URLFOR($Resource.ckeditor,'ckeditor/ckeditor.js')}"></script> -->
<script type="text/javascript">
    
    
    var toolbar_items = "insertfile undo redo | fontselect | fontsizeselect | styleselect | forecolor backcolor | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link customimg";
    var menu_bar = true;
    
    tinymce.init({
        editor_selector : "mceEditor",
        editor_deselector : "mceNoEditor",
        browser_spellcheck : true,        
        forced_root_block : 'div',
        branding: false, 
        mode: "textareas",
        plugins: [
        "advlist anchor autolink autoresize charmap colorpicker hr image",
        "lists link media nonbreaking searchreplace template",
        "insertdatetime table paste"
        ],
        toolbar: toolbar_items,
        menubar: menu_bar,
        button_tile_map : true,
        use_salesforce_proxy : "TRUE",
        height : "500",
        // Theme options
        theme_advanced_buttons1 : "fontselect,fontsizeselect,|,bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,fullscreen",
        theme_advanced_buttons2 : "pastetext,pasteword,selectall,|,search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,code,|,forecolor,backcolor,|,spellchecker,|,print,|,help",
        theme_advanced_buttons3 : "",
        theme_advanced_buttons4 : "",
        theme_advanced_toolbar_location : "top",
        theme_advanced_toolbar_align : "left",
        theme_advanced_statusbar_location : "none",
        theme_advanced_resizing : true,
    });
    
</script>

  
        <apex:sectionHeader title="E2A Unmatched Email"  subtitle="{!email.ortoo_e2a__Subject__c}"/>
       
        <apex:form id="UnmatchedEmailDetail" >
        <apex:pageMessages escape="false" />
        <apex:outputLink value="/{!goBack}" rendered="{!editIsActive == false}">Back to List: Unmatched Emails</apex:outputLink>
        <br/><br/>
        <apex:pageBlock title="e2a Unmatched Email Detail" rendered="{!editIsActive == false}" id="pb_view"> 
            
            <apex:pageBlockButtons >
            <apex:commandButton action="{!EditButton}" value="Edit"/>
            <apex:commandButton action="{!deleteEmail}" value="Delete" onclick="if (!window.confirm('Are you sure?')) return false;" rendered="{!DeleteIsAllowed}"/>
            <apex:commandButton action="{!matchEmail}" value="Match"/>
            </apex:pageBlockButtons>
            
            <apex:pageBlockSection columns="2" collapsible="false">
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Message Date"/>
                    <apex:outputField value="{!email.ortoo_e2a__Message_Date__c}"/>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Subject"/>
                    <apex:outputField value="{!email.ortoo_e2a__Subject__c}"/>
                </apex:pageBlockSectionItem>
                
            
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Email Rule"/>
                    <apex:outputField value="{!email.ortoo_e2a__Email_Services_Function__c}"/>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Owner"/>
                    <apex:outputPanel >
                    <apex:outputLink value="/setup/own/groupdetail.jsp?id={!email.OwnerId}" rendered="{!email.Owner.Type=='Queue'}" >{!email.Owner.Name}</apex:outputLink>
                    <apex:outputLink value="/{!email.OwnerId}" rendered="{!email.Owner.Type=='User'}" >{!email.Owner.Name}</apex:outputLink>&nbsp;
                    <apex:outputLink value="/{!email.Id}%2Fa?retURL=/apex/ortoo_e2a__UnmatchedEmailDetail?id={!email.Id}">[Change]</apex:outputLink>
                </apex:outputPanel>
                </apex:pageBlockSectionItem>
                
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Reason Not Matched"/>
                    <apex:outputField value="{!email.ortoo_e2a__Reason__c}"/>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Exception Message"/>
                    <apex:outputField value="{!email.ortoo_e2a__Exception_Message__c}"/>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                     <apex:outputLabel value="Created By" for="created_by"/>
                    <apex:outputPanel >
                        <apex:outputLink value="/{!email.CreatedById}">{!email.CreatedBy.Name}</apex:outputLink>,&nbsp;
                        <apex:outputField value="{!email.CreatedDate}"/>
                    </apex:outputPanel>
                    
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Last Modified By" for="modified_by"/>
                    <apex:outputPanel >
                        <apex:outputLink value="/{!email.LastModifiedById}">{!email.LastModifiedBy.Name}</apex:outputLink>,&nbsp;
                        <apex:outputField value="{!email.LastModifiedDate}"/>
                    </apex:outputPanel>
                    
                </apex:pageBlockSectionItem>
                
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Importance"/>
                    <apex:outputField value="{!email.ortoo_e2a__Importance__c}"/>
                </apex:pageBlockSectionItem>
                
                </apex:pageBlockSection>
                
                <apex:pageBlockSection columns="1" collapsible="false" title="Address Information">
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="From Address"/>
                    <apex:outputPanel >
                        <apex:outputField value="{!email.ortoo_e2a__From_Address__c}" rendered="{!email.ortoo_e2a__From_Address__c != null}"/>
                        <apex:outputText value="{!email.ortoo_e2a__New_From_Address__c}" rendered="{!AND(email.ortoo_e2a__From_Address__c == null,email.ortoo_e2a__New_From_Address__c != null)}"/>
                    </apex:outputPanel>
                    
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="From Name"/>
                    <apex:outputField value="{!email.ortoo_e2a__From_Name__c}"/>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="To Address"/>
                    <apex:outputField value="{!email.ortoo_e2a__To_Address__c}"/> 
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Cc Address"/>
                    <apex:outputField value="{!email.ortoo_e2a__Cc_Address__c}"/>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Bcc Address"/>
                    <apex:outputField value="{!email.ortoo_e2a__Bcc_Address__c}"/>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Headers"/>
                    <!-- <apex:outputField value="{!email.Headers__c}"/>-->
                    <a href="#" onclick="window.open('/apex/ortoo_e2a__viewsourcepopup?id={!email.Id}&mode=header', 'Popup','height=600,width=670,left=100,top=100,resizable=no,scrollbars=yes,toolbar=no,status=no');"><b>View</b></a>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Message Id"/>
                    <apex:outputField value="{!email.ortoo_e2a__Message_Id__c}"/>
                </apex:pageBlockSectionItem>
                
                </apex:pageBlockSection>
                
                <apex:pageBlockSection id="EmailInformation" columns="1" collapsible="false" title="Email Information">
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Subject"/>
                    <apex:outputField value="{!email.ortoo_e2a__Subject__c}"/>
                </apex:pageBlockSectionItem>
            <apex:pageBlockSectionItem rendered="{!OR(HtmlBody == null, HtmlBody == '')}" >
                <apex:outputLabel value="Body"/>
                <apex:outputText value="{!TextBody}" styleClass="wrapText dont-break-out"/>
            </apex:pageBlockSectionItem>
            <apex:pageBlockSectionItem id="HtmlBodyView" rendered="{!HtmlBody != null}" >
                <apex:outputLabel value="Body"/>
                <apex:outputPanel >
                <a href="#" onclick="window.open('/apex/ortoo_e2a__viewsourcepopup?id={!email.Id}&mode=html', 'Popup','height=600,width=670,left=100,top=100,resizable=no,scrollbars=yes,toolbar=no,status=no');"><font color="blue">[<b>View Source</b>]</font></a>
                <br/><br/>
                <!-- <apex:dynamicComponent componentValue="{!HtmlBodyView}"/>  -->
                <apex:outputText id="HtmlBodyId" value="{!HtmlBody}" styleClass="wrapText dont-break-out "/>
                </apex:outputPanel>
            </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
               
                
		</apex:pageBlock>
                
    	<apex:pageBlock title="e2a Unmatched Email Detail" rendered="{!editIsActive == true}" id="thepb">
        
	        <apex:pageBlockButtons >
	            <apex:commandbutton value="Save"  Title="Save" action="{!SaveButton}"/>
	            <apex:commandbutton value="Cancel" Title="Cancel" action="{!CancelButton}"/>
	        </apex:pageBlockButtons>
	        
	        <apex:pageBlockSection >
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="Message Date"/>
	                <apex:inputField value="{!email.ortoo_e2a__Message_Date__c}"/>
	            </apex:pageBlockSectionItem>
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="Subject"/>
	                    <apex:outputField value="{!email.ortoo_e2a__Subject__c}"/>
	            </apex:pageBlockSectionItem>
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="Email Rule"/>
	                    <apex:inputField value="{!email.ortoo_e2a__Email_Services_Function__c}"/>
	            </apex:pageBlockSectionItem>
	            <apex:pageBlockSectionItem rendered="{!is_new_queued_message== false}">
	                <apex:outputLabel value="Owner"/>              
	                      <apex:inputField value="{!email.Owner.Name}"/>                    
	            </apex:pageBlockSectionItem>
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="Reason Not Matched"/>
	                    <apex:inputField value="{!email.ortoo_e2a__Reason__c}"/>
	            </apex:pageBlockSectionItem>
	             <apex:pageBlockSectionItem >
	                    <apex:outputLabel value="Exception Message"/>
	                    <apex:inputField value="{!email.ortoo_e2a__Exception_Message__c}"/>
	                </apex:pageBlockSectionItem>
	                <apex:pageBlockSectionItem >
	                    <apex:outputLabel value="Importance"/>
	                    <apex:inputField value="{!email.ortoo_e2a__Importance__c}"/>
	                </apex:pageBlockSectionItem>             
	            </apex:pageBlockSection>
	                 
	            <apex:pageBlockSection title="Address Information" collapsible="false" columns="1">
	            
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="From Address"/>
	                <apex:outputPanel >
	                     <apex:inputField value="{!email.ortoo_e2a__From_Address__c}" StyleClass="inputField" rendered="{!email.ortoo_e2a__New_From_Address__c == null}"/>
	                     <apex:inputField value="{!email.ortoo_e2a__New_From_Address__c}" StyleClass="inputField" rendered="{!AND(email.ortoo_e2a__From_Address__c == null,email.ortoo_e2a__New_From_Address__c != null)}"/>
	                </apex:outputPanel>
	            </apex:pageBlockSectionItem>
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="From Name"/>
	                <apex:inputField value="{!email.ortoo_e2a__From_Name__c}" StyleClass="inputField"/>
	            </apex:pageBlockSectionItem>
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="To Address"/>
	                <apex:inputField value="{!email.ortoo_e2a__To_Address__c}" StyleClass="inputField"/>
	            </apex:pageBlockSectionItem>
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="Cc Address"/>
	                <apex:inputField value="{!email.ortoo_e2a__Cc_Address__c}" StyleClass="inputField"/>
	            </apex:pageBlockSectionItem>
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="Bcc Address"/>
	                <apex:inputField value="{!email.ortoo_e2a__Bcc_Address__c}" StyleClass="inputField"/>
	            </apex:pageBlockSectionItem>
	            
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="Headers"/>
	                <apex:inputText value="{!emailHeaders}" StyleClass="inputField"/>
	            </apex:pageBlockSectionItem>
	            
	            <apex:pageBlockSectionItem >
	                <apex:outputLabel value="Message Id"/>
	                    <apex:inputField value="{!email.ortoo_e2a__Message_Id__c}" StyleClass="inputField"/>
	            </apex:pageBlockSectionItem>
	        </apex:pageBlockSection>
	        
	        <apex:pageBlockSection columns="1" collapsible="false" title="Email Information" id="pbs">
	                <apex:pageBlockSectionItem >
	                    <apex:outputLabel value="Subject" />
	                    <apex:inputField value="{!email.ortoo_e2a__Subject__c}" StyleClass="inputField"/>
	                </apex:pageBlockSectionItem>
	
	             <apex:pageBlockSectionItem >
	                 <apex:outputLabel value="Email Format" for="html_switch"/>
	                 <apex:outputText >{!CurrentMailFormat} [
	                     <apex:commandLink id="html_switch" action="{!SwitchMailFormat}"  onclick="if (!switchMailAlert()) return false;">
	                     Switch to: {!SwitchToMailFormat}
	                     </apex:commandLink> 
	                 ]
	                 </apex:outputText>
	            </apex:pageBlockSectionItem>
	
	            <apex:pageBlockSectionItem id="pbSI_body">
	                        <apex:outputLabel value="Body" for="email_body"/>
	                        <apex:outputPanel id="editor_panel" layout="block" style="display:none;width:90%;">
	                            <apex:inputTextarea id="email_body" styleClass="mceEditor" value="{!HtmlBody}" rows="15" cols="130" style="width:90%;" rendered="{!ishtmlrender}"/>
	                    <apex:inputTextarea value="{!TextBody}" StyleClass="inputField" rendered="{!ishtmlrender == false}" rows="8" style="width:89%;"/>                    
	                </apex:outputPanel>
	           </apex:pageBlockSectionItem>
	                    
	        </apex:pageBlockSection>    
	    </apex:pageBlock>
    </apex:form>
    <apex:relatedList list="CombinedAttachments" rendered="{!editIsActive == false}">
    </apex:relatedList>

<script>
/*Richtext
    if ({!JSENCODE($CurrentPage.parameters.isrichtext)} == false) 
    {
        document.getElementById('thePage:UnmatchedEmailDetail:thePB:pbS:pbSI_body:email_body').className = 'ckeditorToNone';
        var textarea_instance = document.getElementById('thePage:UnmatchedEmailDetail:thePB:pbS:pbSI_body:email_body');
        textarea_instance.value = textarea_instance.value.replace(/\n\s*\n/g, '\n');
    }
*/
</script>

</apex:page>