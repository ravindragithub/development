<apex:page standardController="Opportunity" extensions="invoiceit_crmx.CreateOpportunityProductsController" tabStyle="Opportunity">
    <apex:includeScript value="{!URLFOR($Resource.invoiceit_s__jQuery, 'js/jquery-1.5.1.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.invoiceit_s__jQuery, 'js/jquery-ui-1.8.14.custom.min.js')}" />
    <apex:stylesheet value="{!URLFOR($Resource.invoiceit_s__jQuery,'css/smoothness/jquery-ui-1.8.14.custom.css')}"/>
     <script>
        var isSaving;
        isSaving = false;
        function confirmCancel() {
            var isCancel = confirm("{!$Label.invoiceit_s__CancellingthiswoulddiscardthechangesPleaseconfirm}");
            if (isCancel) return true;
            return false;
        }
        
        $j = jQuery.noConflict();
        $j(document).ready(function() {
            $j("#dialog").dialog({  autoOpen: false, modal: true, position: 'center', width: 190, 
                                   height:70, dialogClass: "ui-dialog-no-titlebar ui-dialog-no-padding", resizable: true});
        });
        /*Function to show the modal dialog for jquery*/
        function showDialog(){
            $j("#dialog").dialog("open");
            $j('#dialog').dialog('option', 'position', 'center');
            return false;
        }
        /*Function to hide the modal dialog for jquery*/
        function closeDialog(){
            $j("#dialog").dialog("close");
            return false;
        }
        
        function disableBtn() {
            isSaving = true;
            $j('.disablebutton').addClass('btnDisabled');
            $j('.disablebutton').attr({value:'Saving...',disabled:'disabled'});
            $j('.disablebuttonSave').addClass('btnDisabled');
            $j('.disablebuttonSave').attr('value','Saving...');
            
        }
        
    </script>
    <apex:sectionHeader title="Step 2 of 2" subtitle="{!Opportunity.Name}" />
    <apex:outputField value="{!Opportunity.invoiceit_crmx__CurrencyL__c}" rendered="false"/>
    <apex:form >
        <apex:actionStatus id="status" onstart="return showDialog()" onstop="return closeDialog()" />
        <apex:pageBlock id="pb">
            <apex:pagemessages id="pageMessages" />
            <apex:pageBlockButtons >
                <apex:commandButton action="{!step1}" value="{!$Label.invoiceit_s__ButtonPrevious}" styleClass="disablebutton"/>
                <!--
                    Modified By     : Asish Kumar Behera
                    Modified Date   : 28-02-2014
                    JIRA Task       : INVOICEIT-320
                    Comments        : previously when user clicks twice on the button it creates two invoices, 
                                      disable the button when user click on button
                   -->
                   <!--
                    Modified By     : Rama Krishna.v
                    Modified Date   : 4-4-2014
                    JIRA Task       : INVOICEIT-320
                    Comments        : added style classes to below buttons.
                   -->
                <apex:actionStatus id="saveStatus">
                
                    <apex:facet name="stop">
                        <apex:commandButton action="{!saveOpportunity_vf}" value="{!$Label.invoiceit_s__ButtonSave}" reRender="pageMessages,pb" status="saveStatus"  onclick="disableBtn();"  styleClass="disablebutton"/>
                    </apex:facet>
                    <apex:facet name="start">
                        <apex:commandButton value="Saving..." disabled="true" status="saveStatus"/>
                    </apex:facet>
                                    
                </apex:actionStatus>
                
                 <!--
                    Modified By     : Rama Krishna.v
                    Modified Date   : 4-4-2014
                    JIRA Task       : INVOICEIT-320
                    Comments        : added style classes to below buttons.
                   -->
                 <!--  <apex:commandButton action="{!saveOpportunity_vf}" value="{!$Label.invoiceit_s__ButtonSave}" onclick="disableBtn();"  styleClass="disablebuttonSave"/>  -->
                <!--<apex:commandButton action="{!saveOpportunity_vf}" value="{!$Label.invoiceit_s__ButtonSave}" reRender="pageMessages" status="status" /> -->
                <apex:commandButton value="{!$Label.invoiceit_s__Quick_Save_Button}" action="{!quickSaveOpportunity}" rerender="opportunityRatePlanCharges,subTotal,vat,total,summaryOfCharges,pageMessages" status="status" styleClass="disablebuttonSave"/>
                <apex:commandButton value="{!$Label.invoiceit_s__ButtonUpdate}" action="{!chargeCalculator}" rerender="opportunityRatePlanCharges,subTotal,vat,total,summaryOfCharges,pageMessages" status="status" styleClass="disablebuttonSave"/>
                <apex:commandButton action="{!cancel}" value="{!$Label.invoiceit_s__ButtonCancel}" onclick="return confirmCancel()" immediate="true" styleClass="disablebuttonSave"/>
    
            </apex:pageBlockButtons>      
            
            <apex:pageBlockSection title="Products" id="opportunityRatePlanCharges" columns="1" collapsible="false">
            <apex:outputPanel id="test">
                <table cellspacing="0" cellpadding="0" border="0" class="list">
                    <thead class="rich-table-thead">
                    <tr class="headerRow">
                        <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Product__c.FieldSets.invoiceit_crmx__ProductFieldsInStep2}" var="fieldAPI">
                            <th colspan="1" scope="col" class="headerRow">
                                <div>
                                    {!fieldAPI.Label}
                                </div>
                            </th> 
                        </apex:repeat>
                        <th colspan="1" scope="col" class="headerRow">
                          <div>
                          {!$Label.invoiceit_s__Quantity}
                          </div>
                        </th>
                        <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Rate_Plan_Charge__c.FieldSets.invoiceit_crmx__OpportunityProds_Wizard_Step2}" var="fieldAPI">
                            <th colspan="1" scope="col" class="headerRow">
                                <div>
                                <apex:OutputLabel value="{!fieldAPI.Label}" rendered="{!fieldAPI != 'invoiceit_crmx__Discount_Value__c' && fieldAPI != 'invoiceit_crmx__Discount_Percent__c'}"/>
                                <apex:OutputLabel value="{!fieldAPI.Label}" rendered="{!(displayDiscountRowinOpportunityPage2 && fieldAPI == 'invoiceit_crmx__Discount_Percent__c') || (displayDiscountRowinOpportunityPage2 && fieldAPI == 'invoiceit_crmx__Discount_Value__c')}"/>
                                  
                                </div>
                            </th>
                        </apex:repeat>
                    </tr>
                </thead>
                <tbody>
                    <apex:repeat value="{!opportunityClass.opportunityProducts}" var="opportunityproduct">
                        <apex:repeat value="{!opportunityproduct.opportunityRatePlans}" var="opportunityrateplan">
                            <apex:repeat value="{!opportunityrateplan.opportunityRatePlanCharges}" var="opportunityrateplancharge">
                                <tr onfocus="if (window.hiOn){hiOn(this);}" onblur="if (window.hiOff){hiOff(this);}" onmouseout="if (window.hiOff){hiOff(this);}" onmouseover="if (window.hiOn){hiOn(this);}" class="dataRow even odd first">
                                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Product__c.FieldSets.invoiceit_crmx__ProductFieldsInStep2}" var="fieldAPI">
                                        <td colspan="1" class="dataCell">
                                            <apex:outputField value="{!opportunityproduct.Opportunityproduct[fieldAPI]}" rendered="{!opportunityrateplancharge.opportunityRatePlanCharge.invoiceit_crmx__Sequence_No__c <= 1}"/>
                                        </td>
                                    </apex:repeat>
                                    <td colspan="1" class="dataCell">
                                        <apex:inputField value="{!opportunityrateplancharge.opportunityrateplancharge.invoiceit_crmx__Quantity__c}" required="true" rendered="{!opportunityrateplancharge.isQuantityEditable == true}"  style="width:70px">
                                            <apex:param value="{0,number,0}" />
                                        </apex:inputField>
                                        
                                        <apex:outputField value="{!opportunityrateplancharge.opportunityrateplancharge.invoiceit_crmx__Quantity__c}" rendered="{!opportunityrateplancharge.isQuantityEditable != true}"  style="width:70px">
                                            <apex:param value="{0,number,0}" />
                                        </apex:outputField>
                                    </td>
                                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Rate_Plan_Charge__c.FieldSets.invoiceit_crmx__OpportunityProds_Wizard_Step2}" var="fieldAPI">
                                        <td colspan="1" class="dataCell">
                                          <!-- INVOICEITCRM-41 -->
                                          <apex:outputField value="{!opportunityrateplancharge.opportunityrateplancharge[fieldAPI]}" rendered="{!fieldAPI != 'invoiceit_crmx__Discount_Value__c' && fieldAPI != 'invoiceit_crmx__Discount_Percent__c'}"/>
                                    
                                          <apex:outputField value="{!opportunityrateplancharge.opportunityrateplancharge[fieldAPI]}" rendered="{!fieldAPI == 'invoiceit_crmx__Discount_Percent__c' && opportunity_LevelDiscount_By != 'APPLY_DISCOUNT_BY_PERCENTAGE' && displayDiscountRowinOpportunityPage2}"/>                                           
                                          <apex:inputField value="{!opportunityrateplancharge.opportunityrateplancharge[fieldAPI]}" rendered="{!fieldAPI == 'invoiceit_crmx__Discount_Percent__c' && opportunity_LevelDiscount_By == 'APPLY_DISCOUNT_BY_PERCENTAGE' && displayDiscountRowinOpportunityPage2}"/> 
                                        
                                          <apex:outputField value="{!opportunityrateplancharge.opportunityrateplancharge[fieldAPI]}" rendered="{!fieldAPI == 'invoiceit_crmx__Discount_Value__c' && opportunity_LevelDiscount_By != 'APPLY_DISCOUNT_BY_VALUE' && displayDiscountRowinOpportunityPage2}"/>                                           
                                          <apex:inputField value="{!opportunityrateplancharge.opportunityrateplancharge[fieldAPI]}" rendered="{!fieldAPI == 'invoiceit_crmx__Discount_Value__c' && opportunity_LevelDiscount_By == 'APPLY_DISCOUNT_BY_VALUE' && displayDiscountRowinOpportunityPage2}"/> 
                                        </td>
                                    </apex:repeat>
                                </tr>
                            </apex:repeat>
                        </apex:repeat>
                    </apex:repeat>
                   
                <tr onfocus="if (window.hiOn){hiOn(this);}" onblur="if (window.hiOff){hiOff(this);}" onmouseout="if (window.hiOff){hiOff(this);}" onmouseover="if (window.hiOn){hiOn(this);}" class="dataRow odd even">
                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Product__c.FieldSets.invoiceit_crmx__ProductFieldsInStep2}" var="fieldAPI">
                        <td colspan="1" class="dataCell"/>
                    </apex:repeat>
                                                        
                    <td colspan="1" class="dataCell">
                        <apex:inputField value="{!opportunityClass.opportunity[discountCode]}" rendered="{!isDisableDiscount && isDisableDiscount && displayDiscountRowinOpportunityPage2}" style="width:80px"/>
                        <apex:commandButton value="{!$Label.invoiceit_s__ButtonApplyDiscountCode}" action="{!applyDiscountCode}" status="status" rerender="opportunityRatePlanCharges,subTotal,vat,total,summaryOfCharges,pageMessages" rendered="{!isDisableDiscount && isDisableDiscount && displayDiscountRowinOpportunityPage2}"/>
                    </td> 
                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Rate_Plan_Charge__c.FieldSets.invoiceit_crmx__OpportunityProds_Wizard_Step2}" var="fieldAPI">
                        <td colspan="1" class="dataCell">
                            <apex:outputText value="{!$Label.invoiceit_s__TotalDiscountValue}({!sCurrencyName})" rendered="{!fieldAPI == 'invoiceit_crmx__Unit_Price__c' && opportunity_LevelDiscount_By == 'APPLY_DISCOUNT_BY_VALUE' && displayDiscountRowinOpportunityPage2}"/>
                            <apex:inputField value="{!opportunityClass.opportunity.invoiceit_crmx__Discount_Value__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c' && opportunity_LevelDiscount_By == 'APPLY_DISCOUNT_BY_VALUE' && isDisableDiscount && displayDiscountRowinOpportunityPage2}"/>
                            <apex:outputField value="{!opportunityClass.opportunity.invoiceit_crmx__Discount_Value__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c' && opportunity_LevelDiscount_By == 'APPLY_DISCOUNT_BY_VALUE' && !isDisableDiscount && displayDiscountRowinOpportunityPage2}"/>
                            <apex:commandButton value="{!$Label.invoiceit_s__ButtonApplyDiscount}" action="{!applyDiscountValueToCharges}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c' && opportunity_LevelDiscount_By == 'APPLY_DISCOUNT_BY_VALUE' && isDisableDiscount && displayDiscountRowinOpportunityPage2}" rerender="opportunityRatePlanCharges,subTotal,vat,total,summaryOfCharges,pageMessages" status="status"/>
                            
                            <apex:outputText value="{!$Label.invoiceit_s__DiscountPercent}" rendered="{!fieldAPI == 'invoiceit_crmx__Unit_Price__c' && opportunity_LevelDiscount_By == 'APPLY_DISCOUNT_BY_PERCENTAGE' && displayDiscountRowinOpportunityPage2}"/>
                            <apex:inputField value="{!opportunityClass.opportunity.invoiceit_crmx__Discount_Percent__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c' && opportunity_LevelDiscount_By == 'APPLY_DISCOUNT_BY_PERCENTAGE' && isDisableDiscount && displayDiscountRowinOpportunityPage2}"/>
                            <apex:outputField value="{!opportunityClass.opportunity.invoiceit_crmx__Discount_Percent__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c' && opportunity_LevelDiscount_By == 'APPLY_DISCOUNT_BY_PERCENTAGE' && !isDisableDiscount && displayDiscountRowinOpportunityPage2}"/>
                            <apex:commandButton value="{!$Label.invoiceit_s__ButtonApplyDiscount}" action="{!applyDiscountPercentToCharges}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c' && opportunity_LevelDiscount_By == 'APPLY_DISCOUNT_BY_PERCENTAGE' && isDisableDiscount && displayDiscountRowinOpportunityPage2}" rerender="opportunityRatePlanCharges,subTotal,vat,total,summaryOfCharges,pageMessages" status="status"/>
                        </td>
                    </apex:repeat>
                </tr>
               
                <tr onfocus="if (window.hiOn){hiOn(this);}" onblur="if (window.hiOff){hiOff(this);}" onmouseout="if (window.hiOff){hiOff(this);}" onmouseover="if (window.hiOn){hiOn(this);}" class="dataRow odd even">
                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Product__c.FieldSets.invoiceit_crmx__ProductFieldsInStep2}" var="fieldAPI">
                        <td colspan="1" class="dataCell"/>
                    </apex:repeat>
                    <td colspan="1" class="dataCell"/>
                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Rate_Plan_Charge__c.FieldSets.invoiceit_crmx__OpportunityProds_Wizard_Step2}" var="fieldAPI">
                        <td colspan="1" class="dataCell">
                            <apex:outputText value="{!$Label.invoiceit_s__SubTotal}" rendered="{!fieldAPI == 'invoiceit_crmx__Unit_Price__c'}"/>
                            <apex:outputText value="{!sCurrencyName}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c'}"/>&nbsp;&nbsp;
                            <apex:outputField value="{!opportunityClass.opportunity.invoiceit_crmx__Sub_Total__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c'}"/>
                        </td>
                    </apex:repeat>
                </tr>                 
                
                <tr onfocus="if (window.hiOn){hiOn(this);}" onblur="if (window.hiOff){hiOff(this);}" onmouseout="if (window.hiOff){hiOff(this);}" onmouseover="if (window.hiOn){hiOn(this);}" class="dataRow odd even">
                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Product__c.FieldSets.invoiceit_crmx__ProductFieldsInStep2}" var="fieldAPI">
                        <td colspan="1" class="dataCell"/>
                    </apex:repeat>
                    <td colspan="1" class="dataCell"/>
                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Rate_Plan_Charge__c.FieldSets.invoiceit_crmx__OpportunityProds_Wizard_Step2}" var="fieldAPI">
                        <td colspan="1" class="dataCell">
                            <apex:outputText value="{!$Label.invoiceit_s__Vat}" rendered="{!fieldAPI == 'invoiceit_crmx__Unit_Price__c' && displayVATRowinOpportunityPage2}"/>  
                            <apex:outputText value="{!sCurrencyName}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c' && displayVATRowinOpportunityPage2}"/>&nbsp;&nbsp;
                            <apex:outputField value="{!opportunityClass.opportunity.invoiceit_crmx__VAT__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c' && displayVATRowinOpportunityPage2}"/>
                        </td>
                    </apex:repeat>
                </tr>
                
                <tr onfocus="if (window.hiOn){hiOn(this);}" onblur="if (window.hiOff){hiOff(this);}" onmouseout="if (window.hiOff){hiOff(this);}" onmouseover="if (window.hiOn){hiOn(this);}" class="dataRow odd even">
                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Product__c.FieldSets.invoiceit_crmx__ProductFieldsInStep2}" var="fieldAPI">
                        <td colspan="1" class="dataCell"/>
                    </apex:repeat>
                    <td colspan="1" class="dataCell"/>
                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Rate_Plan_Charge__c.FieldSets.invoiceit_crmx__OpportunityProds_Wizard_Step2}" var="fieldAPI">
                        <td colspan="1" class="dataCell">
                            <apex:outputText value="{!$Label.invoiceit_s__Tax}" rendered="{!fieldAPI == 'invoiceit_crmx__Unit_Price__c' && displayTAXRowinOpportunityPage2}"/>  
                            <apex:outputText value="{!sCurrencyName}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c' && displayTAXRowinOpportunityPage2}"/>&nbsp;&nbsp;
                            <apex:outputField value="{!opportunityClass.opportunity.invoiceit_crmx__Tax__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c' && displayTAXRowinOpportunityPage2}"/>   
                        </td>
                    </apex:repeat>
                </tr>
               
                <tr onfocus="if (window.hiOn){hiOn(this);}" onblur="if (window.hiOff){hiOff(this);}" onmouseout="if (window.hiOff){hiOff(this);}" onmouseover="if (window.hiOn){hiOn(this);}" class="dataRow even odd last">
                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Product__c.FieldSets.invoiceit_crmx__ProductFieldsInStep2}" var="fieldAPI">
                        <td colspan="1" class="dataCell"/>
                    </apex:repeat>
                    <td colspan="1" class="dataCell"/>
                    <apex:repeat value="{!$ObjectType.invoiceit_crmx__Opportunity_Rate_Plan_Charge__c.FieldSets.invoiceit_crmx__OpportunityProds_Wizard_Step2}" var="fieldAPI">
                        <td colspan="1" class="dataCell">
                            <apex:outputText value="{!$Label.invoiceit_s__TotalAmount}" rendered="{!fieldAPI == 'invoiceit_crmx__Unit_Price__c'}"/>
                            <apex:outputText value="{!sCurrencyName}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c'}" />&nbsp;&nbsp;
                            <apex:outputField value="{!opportunityClass.opportunity.invoiceit_crmx__Total__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Price__c'}" />   
                            <apex:outputText value="{!sCurrencyName}" rendered="{!fieldAPI == 'invoiceit_crmx__Cost__c'}"/>&nbsp;&nbsp;                       
                            <apex:outputField value="{!opportunityClass.opportunity.invoiceit_crmx__Total_Cost__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Cost__c'}"/>
                            <apex:outputText value="{!sCurrencyName}" rendered="{!fieldAPI == 'invoiceit_crmx__Profit__c'}"/>&nbsp;&nbsp;
                            <apex:outputField value="{!opportunityClass.opportunity.invoiceit_crmx__Total_Profit__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Profit__c'}"/>
                            <apex:outputText value=" (" rendered="{!fieldAPI == 'invoiceit_crmx__Profit__c'}"/>
                            <apex:outputField value="{!opportunityClass.opportunity.invoiceit_crmx__TotalProfitPercent__c}" rendered="{!fieldAPI == 'invoiceit_crmx__Profit__c'}"/>
                            <apex:outputText value=")" rendered="{!fieldAPI == 'invoiceit_crmx__Profit__c'}"/>
                        </td>
                    </apex:repeat>
                </tr>
                </tbody>
            </table>
            </apex:outputPanel>
        </apex:pageBlockSection>  
        </apex:pageBlock>

        <!-- This div holds the image that is opened as a popup during processing -->
        <div id="dialog">
            <apex:image value="{!URLFOR($Resource.invoiceit_s__jQuery,'/css/smoothness/images/please_wait.gif')}" />
        </div>
   </apex:form>
</apex:page>