<apex:page standardController="Case" extensions="E2CP.CommentListController" title="{!Case.CaseNumber}: Comment List">
    
    
    <apex:includeScript value="/support/console/40.0/integration.js"/>
    <script src="/canvas/sdk/js/publisher.js"></script>
    <script src="{!URLFOR($Resource.jquery,'jquery-1.11.3/jquery.min.js')}"></script>
    
    <!--<link rel="stylesheet" href="{!URLFOR($Resource.jquery,'jquery-ui-1.9.2.custom/css/ui-lightness/jquery-ui-1.9.2.custom.min.css')}" />
    <script src="{!URLFOR($Resource.jquery,'jquery-ui-1.9.2.custom/js/jquery-ui-1.9.2.custom.min.js')}"></script>-->
    
    <script type="text/javascript">
        jQuery.noConflict();
        var j$ = jQuery.noConflict();
        
        function OpenSubPublicCommentTab() {
            //First find the ID of the primary tab to put the new subtab in
            sforce.console.getEnclosingPrimaryTabId(openSubPublicTab);
        }
        function OpenSubPrivateCommentTab() {
            //First find the ID of the primary tab to put the new subtab in
            sforce.console.getEnclosingPrimaryTabId(openSubPrivateTab);
        }
        function OpenSubListCommentTab() {
            //First find the ID of the primary tab to put the new subtab in
            sforce.console.getEnclosingPrimaryTabId(openSubListTab);
        }
        var openSubPublicTab = function openSubtab(result) {
            //Now that we ve got the primary tab ID, we can open a new subtab in it
            var primaryTabId = result.id;
            sforce.console.openSubtab(primaryTabId , "/apex/E2CP__New_Comment?id={!JSENCODE(case.id)}", true, 'Public Comment', null, null, 'salesforceSubtab');
        };
        var openSubPrivateTab = function openSubtab(result) {
            //Now that weve got the primary tab ID, we can open a new subtab in it
            var primaryTabId = result.id;
            //'/00a/e?inline=0&parent_id={!JSENCODE(case.id)}'
            sforce.console.openSubtab(primaryTabId , "/apex/E2CP__New_Comment?id={!JSENCODE(case.id)}&private=true", true, 'Private Comment', null, null, 'salesforceSubtab');
        };
        var openSubListTab = function openSubtab(result) {
            //Now that weve got the primary tab ID, we can open a new subtab in it
            var primaryTabId = result.id;
            sforce.console.openSubtab(primaryTabId , "/apex/E2CP__CommentList?id={!JSENCODE(case.id)}&showFullList=true", true, 'Comment List', null, null, 'salesforceSubtab');
        };
    </script>

    <style type="text/css">
        .tha{ width: 20px;}
        .thb{ width: 40px;}
        .thc{ width: 150px;}
        .thd{ width: 200px;}
        .noBottomBorder { border-bottom: 0px solid #000 ! important }

        html>body {
            padding-top: 0px !important;
            padding-bottom: 0px !important;
        }
    </style>
    
    <script> 
        function showHtmlEmail(cmtid) { 
            w = window.open('', 'preview', 'width=800,height=600,scrollbars=yes,resizable=yes');
            d = w.document;
            d.open('text/html');
            d.write(unescapeHTML(document.getElementById(cmtid).innerHTML));
            d.close();
            return false;
        }
    </script>
    
    <apex:form id="allCommentsF">
        <apex:actionFunction action="{!refreshPage}" name="refreshPage" oncomplete="resize();" reRender="listTable"/>
        <!--<apex:actionFunction action="{!displayHTMLEmail}" name="displayHTMLEmail" reRender="modal">
            <apex:param name="emailId" value=""/>
        </apex:actionFunction>-->
        
        
        <!-- ALL COMMENTS -->
        <apex:pageBlock id="allCommentsPB">
            <apex:pageMessages id="errors"/>
            
            <apex:pageblockButtons >
                <apex:commandButton id="SCCPrivate" onClick="OpenSubPrivateCommentTab(); return false;" Value="{!$Label.e2cp__private_comment_button_label}" />
                <apex:commandButton id="SCCPublic" onClick="OpenSubPublicCommentTab(); return false;" Value="{!$Label.e2cp__public_comment_button_label}" />
                <apex:commandButton id="SCCFullList" onClick="OpenSubListCommentTab(); return false;" rendered="{!NOT(showFullList)}" Value="{!$Label.e2cp__open_list_button_label}" />
                <apex:commandButton id="NoSCCPrivate" onClick="window.open('{!JSENCODE(newPrivateComment)}','_top'); return false;" Value="{!$Label.e2cp__private_comment_button_label}" />
                <apex:commandButton id="NoSCCPublic" onClick="window.open('{!JSENCODE(newPublicCommentURL)}','_top'); return false;" Value="{!$Label.e2cp__public_comment_button_label}" />
                <apex:commandButton id="NoSCCFullList" onClick="window.open('{!JSENCODE(listURL)}','_blank'); return false;" rendered="{!NOT(showFullList)}" Value="{!$Label.e2cp__open_list_button_label}" />
            </apex:pageblockButtons>
            
            <apex:pageBlockSection columns="1" id="allCommentsPBS">
                <apex:outputPanel >
                    <apex:inputCheckbox id="pubFltr" value="{!publicFilter}" onchange="refreshPage();"/> 
                    <apex:outputLabel for="pubFltr">Public Comments</apex:outputLabel>
                    <apex:inputCheckbox style="margin-left:20px;" id="priFltr" value="{!privateFilter}" onchange="refreshPage();"/> 
                    <apex:outputLabel for="priFltr">Private Comments</apex:outputLabel>
                    <apex:inputCheckbox style="margin-left:20px;" id="statFltr" value="{!statusFilter}" onchange="refreshPage();"/> 
                    <apex:outputLabel for="statFltr">Status &amp; Owner Changes</apex:outputLabel>
                    <div style="float:right;">Total Comments: {!commentCount}</div>
                </apex:outputPanel>
                <!--<apex:outputPanel style="overflow-y: scroll; display: block; ">-->
                <apex:pageBlockTable id="listTable" value="{!filteredCommentItems}" style="table-layout:fixed;" styleClass="list" rowClasses="noBottomBorder" var="comment">   
                    <apex:column headerClass="tha" style="vertical-align: top; border-top: 1px solid {!JSENCODE(comment.color)}; border-bottom: 0px;">
                        <apex:image value="{!URLFOR($Resource.E2CP__CommentListIcons, 'email-in.png')}" height="16" rendered="{!AND(NOT(ISNULL(comment.em)),comment.em.Incoming)}"/>
                        <apex:image value="{!URLFOR($Resource.E2CP__CommentListIcons, 'email-out.png')}" height="16" rendered="{!AND(NOT(ISNULL(comment.em)),NOT(comment.em.Incoming))}"/>
                        <apex:image value="{!URLFOR($Resource.E2CP__CommentListIcons, 'comment-public.png')}" height="16" rendered="{!AND(NOT(ISNULL(comment.cmt)),comment.cmt.IsPublished,ISNULL(comment.em))}"/>
                        <apex:image value="{!URLFOR($Resource.E2CP__CommentListIcons, 'alarm.png')}" height="16" rendered="{!ISNULL(comment.cmt)}"/>
                        <apex:image value="{!URLFOR($Resource.E2CP__CommentListIcons, 'comment-private.png')}" height="16" rendered="{!AND(ISNULL(comment.em),NOT(OR(ISNULL(comment.cmt),comment.cmt.IsPublished)))}"/> 
                    </apex:column>
                    <apex:column headerClass="tha" style="vertical-align: top; border-top: 1px solid {!JSENCODE(comment.color)}; border-bottom: 0px;">
                        <a name="{!NULLVALUE(comment.cmt.id,comment.hstry.id)}"/><apex:outputLink target="_parent" value="{!$Page.CommentList}?id={!CaseId}#{!NULLVALUE(comment.cmt.id,comment.hstry.id)}">{!comment.ord}</apex:outputLink>
                     </apex:column>  
                    <apex:column headerClass="thc" style="vertical-align: top; white-space:nowrap; border-top: 1px solid {!JSENCODE(comment.color)}; border-bottom: 0px;" styleClass="actionColumn" headerValue="Action">
                        <apex:outputText rendered="{!AND(canEditComments, updateable, NOT(ISNULL(comment.cmt)))}">
                            <apex:outputLink value="/{!comment.cmt.id}/e?parent_id={!Case.id}&retURL=%2F{!Case.id}" target="_parent" styleClass="actionLink">Edit</apex:outputLink> |&nbsp;
                        </apex:outputText>
                        <apex:commandLink action="{!comment.togglePublic}" rendered="{!NOT(ISNULL(comment.cmt))}" value="{!IF(comment.cmt.IsPublished,'Make Private','Make Public')}" rerender="allCommentsPBS,errors" styleClass="actionLink"/>
                        <apex:outputPanel rendered="{!canEditComments && NOT(ISNULL(comment.cmt))}"> |&nbsp;</apex:outputPanel>
                        <apex:commandLink action="{!comment.deleteComment}" rendered="{!canEditComments && NOT(ISNULL(comment.cmt))}" value="Delete" styleClass="actionLink" rerender="allCommentsPBS,errors"/>
                    </apex:column> 
                    <apex:column headerClass="thb" style="vertical-align: top; border-top: 1px solid {!JSENCODE(comment.color)}; border-bottom: 0px;" headerValue="Public">
                        <apex:outputField rendered="{!NOT(ISNULL(comment.cmt))}" value="{!comment.cmt.IsPublished}" />
                    </apex:column>
                    
                   <apex:column headerValue="Comment" style="border-top: 1px solid {!JSENCODE(comment.color)}; border-bottom: 0px; word-wrap:break-word;" styleClass="{!    comment.em.id}">
                        <apex:outputPanel rendered="{!NOT(ISNULL(comment.cmt))}" style="word-wrap:break-word;">
                            <b><apex:outputText value="Created by: "/><apex:outputField value="{!comment.cmt.CreatedById}"/>
                            (<apex:outputField value="{!comment.cmt.CreatedDate}"/>)</b>
                            <br/><span style="color: #000; word-wrap:break-word;"><apex:outputField value="{!comment.cmt.CommentBody}"/></span>
                        </apex:outputPanel>
                        <apex:outputPanel rendered="{!ISNULL(comment.cmt)}">
                            <strong><apex:outputField value="{!comment.hstry.Field}"/></strong> changed from&nbsp;<apex:outputField value="{!comment.hstry.OldValue}"/> to&nbsp;<strong><apex:outputField value="{!comment.hstry.NewValue}"/></strong>
                            by&nbsp;<apex:outputField value="{!comment.hstry.CreatedById}"/>
                            on&nbsp;<apex:outputField value="{!comment.hstry.CreatedDate}"/>.
                       </apex:outputPanel>
                    </apex:column>
                    <apex:column headerClass="thd" style="vertical-align: top; border-top: 1px solid {!JSENCODE(comment.color)}; border-bottom: 0px;" >
                        <!-- <table border="0" >
                            <tr>
                                <td class="noBottomBorder">
                                    <apex:image value="{!URLFOR($Resource.commentListIcons, 'email-in.png')}" height="16" rendered="{!AND(NOT(ISNULL(comment.em)),comment.em.Incoming)}"/>
                                    <apex:image value="{!URLFOR($Resource.commentListIcons, 'email-out.png')}" height="16" rendered="{!AND(NOT(ISNULL(comment.em)),NOT(comment.em.Incoming))}"/> 
                                 </td>
                                 <td class="noBottomBorder">
                                    <apex:outputLink value="/{!comment.em}" target="_BLANK" rendered="{!NOT(ISNULL(comment.em))}">Email</apex:outputLink><br/>
                                </td>
                            </tr>
                        </table> -->
                        <apex:outputLink onclick="showHtmlEmail('{!comment.em.id}');return false;" rendered="{!NOT(ISNULL(comment.em.htmlbody))}">HTML Email</apex:outputLink><br/>
                        <apex:outputLink value="/{!comment.em}" target="_BLANK" rendered="{!NOT(ISNULL(comment.em))}">Email</apex:outputLink><br/>
                        
                        <div style="display:none;" id="{!comment.em.id}"> {!comment.em.HtmlBody} </div>
                        
                        <apex:repeat value="{!comment.attch}" var="attch">
                            Attachment: &lt;<apex:outputLink target="_BLANK" value="/servlet/servlet.FileDownload?file={!attch.id}">{!attch.name}</apex:outputLink>&gt;<br/>
                        </apex:repeat>
                        <apex:repeat value="{!comment.files}" var="file">
                            File: &lt;<apex:outputLink target="_BLANK" value="/{!file.ContentDocument.LatestPublishedVersionId}">{!file.ContentDocument.Title}</apex:outputLink>&gt;<br/>
                        </apex:repeat>
                    </apex:column>
                </apex:pageBlockTable>
                <!--</apex:outputPanel>-->
            </apex:pageBlockSection>
        </apex:pageBlock>
        
        <!--<apex:outputPanel id="modal" layout="inline">
            <div id="html-modal" style="display:none;">
                <apex:outputText escape="false" value="{!eml.HtmlBody}"/>
            </div>
            <script>
                if ({!eml != null}) {
                    j$('#html-modal').dialog({
                        width: 800,
                        height: Math.min(700,document.body.scrollHeight),
                        resizable: true,
                        title: '{!JSENCODE(eml.Subject)}',
                        modal: true,
                        autoOpen: true,
                        position: { my: 'center top', at: 'center top', of: j$('.{!eml.Id}') }
                    });
                    document.activeElement.blur();
                }
            </script>
        </apex:outputPanel>-->
    </apex:form>
    <script>
        function hideButtons() {
            if (sforce.console.isInConsole()) {
                j$("input[id$=':NoSCCPrivate']").hide();
                j$("input[id$=':NoSCCPublic']").hide();
                j$("input[id$=':NoSCCFullList']").hide();
                j$("a[href*='{!$Page.E2CP__CommentList}?id=']").each(
                function() { 
                    this.href = this.href.replace('{!$Page.E2CP__CommentList}?id=', '{!$Page.E2CP__CommentList}?inConsole&id=');
                });
            } else {
                if (window.location.href.indexOf('#00a') != -1 && window.location.href.indexOf('inConsole') == -1) {
                    j$("form[id$=':allCommentsF']").prepend("<p><a href='/{!CaseId}'>Back to Case</a></p>");
                }
                j$("input[id$=':SCCPrivate']").hide();
                j$("input[id$=':SCCPublic']").hide();
                j$("input[id$=':SCCFullList']").hide();
            }
        }
        
        j$(document).ready(init);
        
        function resize() {
            Sfdc.canvas.publisher.resize( { height : document.body.scrollHeight+"px" } );
        }
        
        function init() {
            hideButtons();
            if ({!ENABLE_AUTO_RESIZE_COMMENT_LIST})
                window.setInterval(resize,500);
        }
    </script>
</apex:page>