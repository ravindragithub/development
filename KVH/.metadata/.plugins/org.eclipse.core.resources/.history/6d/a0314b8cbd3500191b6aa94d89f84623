<apex:page controller="FindandAddAccounttoAsset" sidebar="false">
    <script language="JavaScript1.2" src="/js/functions.js"></script>
    <script src="/soap/ajax/9.0/connection.js" type="text/javascript"></script>
    <script>
        var myAssetID;
        sforce.connection.sessionId = '{!$Api.Session_ID}';
        function changeValue(input, textid) {
            document.getElementById(textid).value = input.value;
        }
        
        function ChangeFamily()
        {}
        
        function callCheckBox(myStr,nodePlace)
        {
            myAssetID = myStr;
            if(myAssetID!=null)
            {
            var qr = sforce.connection.query("SELECT id,name,account.name FROM Asset where id='"+ myAssetID +"'");
            var stats = qr.getArray("records");
            var AssetName   = stats[0].Name;
            var AccountName = stats[0].Account.Name;
            var caseAccountName = "{!caseAccountName.Platform_Asset_Account__r.name}";
            var node;
            if(nodePlace=="start")
            {
                var r=confirm("Are you sure you want to move the System : ''"+AssetName+ "'' from: ''"+AccountName+"'' to this Account: ''"+caseAccountName+"''");
                node = "donnotDeleteParentAsset";
            }else
            if(nodePlace=="child" || nodePlace=="end" || nodePlace=="child_end")
            {
                var r=confirm("Are you sure you want to move this Asset : ''"+AssetName+ "'' from: ''"+AccountName+"'' to ''"+caseAccountName+"''");
                node = "performParentAssetDelete";
            }else
            if(nodePlace=="parent_end")
            {    
                var r=confirm("Are you sure you want to move the Intermediate Parent : ''"+AssetName+ "'' and the children from: ''"+AccountName+"'' to this Account: ''"+caseAccountName+"''"); 
                node = "performParentAssetDelete";
            }
            
            if (r==true)
              {
                  CallUpdate(myAssetID,node);
              }
            }else
            {
                alert("Please select atleast one asset");
            }
        }
        
    </script>
 
    <apex:form >
    
        <apex:actionfunction name="CallUpdate" action="{!saveAsset}" rerender="treeView">
            <apex:param name="firstParam" assignTo="{!enteredText1}" value=""/>
            <apex:param name="secondParam" assignTo="{!enteredText2}" value=""/>
        </apex:actionfunction>
        
        <apex:pageblock >
            <apex:pageBlockSection >
                <apex:facet name="header">
                     <span style="color:blue">Search For Create Platform Account to Asset</span>
                </apex:facet> 
                <apex:inputText value="{!SerialNumber}" label="Enter the Serial Number in a Search Box">
                     <apex:actionsupport event="onkeyup" action="{!searchAsset}" reRender="SecondBlock,notFoundAsset" status="LoadingStatus"/> 
                </apex:inputText>
            </apex:pageBlockSection>
             <apex:commandButton value="Back" action="{!Cancel}"/> 
             <apex:commandButton value="Search" action="{!searchAsset}" reRender="SecondBlock,notFoundAsset" status="LoadingStatus"/>
              <apex:actionStatus startText="Loading..." id="LoadingStatus"/>
            
        </apex:pageblock>
        
        <apex:outputPanel id="SecondBlock">
            <apex:pageMessages ></apex:pageMessages>
            <apex:pageblock title="Assets Found" rendered="{!FoundAsset}">
                <apex:pageBlockTable value="{!allAssestRadio}" var="foundAssets">
                    <apex:column headerValue="Select">
                        <input type="radio" name="selectRadio" id="radio">
                              <apex:actionSupport event="onclick" action="{!selectAsset}" rerender="Selected_PBS,treeView">
                                   <apex:param name="id" value="{!foundAssets.SelectedAsset.id}"/>
                              </apex:actionSupport>
                        </input>
                    </apex:column>
                    <apex:column headerValue="Asset Name">
                        <apex:outputField value="{!foundAssets.SelectedAsset.name}"/>
                    </apex:column>
                    <apex:column headerValue="Item Asset Name">
                        <apex:outputField value="{!foundAssets.SelectedAsset.Account.name}"/>
                    </apex:column>
                    <apex:column headerValue="Product Name">
                        <apex:outputField value="{!foundAssets.SelectedAsset.Product2.name}"/>
                    </apex:column>
                    <apex:column headerValue="Service Activation date">
                        <apex:outputField value="{!foundAssets.SelectedAsset.Service_Activation_Date__c}"/>
                    </apex:column>
                    <apex:column headerValue="Date Removed">
                        <apex:outputField value="{!foundAssets.SelectedAsset.Date_Removed__c}"/>
                    </apex:column>
                </apex:pageBlockTable>
            </apex:pageblock>
        </apex:outputPanel>
        
        <apex:outputpanel id="Selected_PBS">
            <apex:pageBlock rendered="{!selectedBlock}" title="Selected Asset">
                <apex:pageBlockTable value="{!selectedAsset}" var="foundAssets">
                   <apex:column headerValue="Asset Name">
                        <apex:outputField value="{!foundAssets.name}"/>
                    </apex:column>
                    <apex:column headerValue="Item Asset Name">
                        <apex:outputField value="{!foundAssets.Account.name}"/>
                    </apex:column>
                    <apex:column headerValue="Product Name">
                        <apex:outputField value="{!foundAssets.Product2.name}"/>
                    </apex:column>
                    <apex:column headerValue="Service Activation date">
                        <apex:outputField value="{!foundAssets.Service_Activation_Date__c}"/>
                    </apex:column>
                    <apex:column headerValue="Date Removed">
                        <apex:outputField value="{!foundAssets.Date_Removed__c}"/>
                    </apex:column>
                </apex:pageBlockTable>
              <!--  <apex:commandButton value="Use Selected Asset" action="{!saveSelectedAsset}"/>
                <apex:commandButton value="Create New Asset" action="{!CreateNewAsset}" rerender="newAssetBlock"/> -->
            </apex:pageBlock>
        </apex:outputpanel>
        
        
        <apex:outputPanel id="treeView">
            <apex:outputPanel rendered="{!selectedBlock}">
                <apex:pageBlock title="Asset Hierarchy">
                    <div class="treeNode">
                    <apex:repeat value="{!ObjectStructure}" var="pos" >
                        <apex:repeat value="{!pos.levelFlag}" var="flag" first="0">
                            <apex:image url="/img/tree/empty.gif" height="16" width="20" rendered="{!IF(flag,false,true)}"/>
                            <apex:image url="/s.gif" alt="" width="3" height="16" rendered="{!IF(flag,true,false)}"/>
                            <apex:image url="/img/tree/chain.gif" height="16" width="20" rendered="{!IF(flag,true,false)}"/>
                        </apex:repeat>
            
                        <span height="16" v="top">
            
                        <apex:outputText rendered="{!IF(pos.nodeType=='start',true,false)}">
                            <apex:image id="tree_start" url="/img/tree/minusStart.gif" height="16" width="20" title="Click to expand/collapse nested items." onClick="TreeNodeElement.prototype.toggle(this,'{!pos.nodeId}')"/>
                            <apex:image id="Icon_start" url="/img/icon/custom51_100/globe16.png" width="16" height="16" rendered="{!IF(pos.currentNode,false,true)}"/>
                            <apex:image id="Icon_start_current" url="/img/icon/star16.png" width="16" height="16" rendered="{!IF(pos.currentNode,true,false)}"/>
                        </apex:outputText>
                        <apex:outputText rendered="{!IF(OR(pos.nodeType=='parent',pos.nodeType=='parent_end'),true,false)}">
                            <apex:image id="Tree_parent" url="/img/tree/minus.gif" rendered="{!IF(pos.nodeType=='parent',true,false)}" height="16" width="20" title="Click to expand/collapse nested items." onClick="TreeNodeElement.prototype.toggle(this,'{!pos.nodeId}')"/>
                            <apex:image id="Tree_parent_end" url="/img/tree/minusEnd.gif" rendered="{!IF(pos.nodeType=='parent_end',true,false)}" height="16" width="20" title="Click to expand/collapse nested items." onClick="TreeNodeElement.prototype.toggle(this,'{!pos.nodeId}')"/>                
                            <apex:image id="Icon_parent" url="/img/icon/factory16.png" width="16" height="16" rendered="{!IF(pos.currentNode,false,true)}"/>
                            <apex:image id="Icon_parent_current" url="/img/icon/star16.png" width="16" height="16" rendered="{!IF(pos.currentNode,true,false)}"/>
                        </apex:outputText>
                        <apex:outputText rendered="{!IF(OR(pos.nodeType=='child',pos.nodeType=='child_end'),true,false)}">
                            <apex:image id="Tree_child" url="/img/tree/node.gif" rendered="{!IF(pos.nodeType=='child',true,false)}" height="16" width="20" title="Click to expand/collapse nested items." onClick="TreeNodeElement.prototype.toggle(this,'{!pos.nodeId}')"/>
                            <apex:image id="Tree_child_current" url="/img/tree/nodeEnd.gif" rendered="{!IF(pos.nodeType=='child_end',true,false)}" height="16" width="20" title="Click to expand/collapse nested items." onClick="TreeNodeElement.prototype.toggle(this,'{!pos.nodeId}')"/>
                            <apex:image id="Icon_child" url="/img/icon/desk16.png" width="16" height="16" rendered="{!IF(pos.currentNode,false,true)}"/>    
                            <apex:image id="Icon_child_current" url="/img/icon/star16.png" width="16" height="16" rendered="{!IF(pos.currentNode,true,false)}"/>
                        </apex:outputText>
                        <apex:outputText rendered="{!IF(pos.nodeType=='end',true,false)}">
                            <apex:image id="Tree_end" url="/img/tree/nodeEnd.gif" height="16" width="20"/>&nbsp;
                            <apex:image id="Icon_end" url="/img/icon/desk16.png" width="16" height="16" rendered="{!IF(pos.currentNode,false,true)}"/>
                            <apex:image id="Icon_end_current" url="/img/icon/star16.png" width="16" height="16" rendered="{!IF(pos.currentNode,true,false)}"/>
                        </apex:outputText>
                        <!-- Change Below -->
                        <!-- Changed for Revision 1 and 2 "Assets" -->
                        <!-- Display the sequence number first (if there is one!) -->
                        
                        
                        <input type="radio" name="selectRadio" id="radio" onchange="callCheckBox('{!pos.asset.id}','{!pos.nodeType}')" value="{!pos.asset.id}"/>
                            
                       
                        
                        <apex:outputText style="{!IF(pos.currentNode,'font-weight: bold;','')}" value="{!pos.asset.Sequence_No__c} ," rendered="{!IF(pos.asset.Sequence_No__c != '', true, false)}"/>
                        <!-- Display the link to the Asset detail page next... -->
                        <em><apex:outputLink value="/{!pos.asset.id}" style="{!IF(pos.currentNode,'font-weight: bold;','')}" styleClass="columnHeadActiveBlack" target="_top">{!pos.asset.name}</apex:outputLink></em>
                        <!-- Display the Item Description -->
                        <apex:outputText style="{!IF(pos.currentNode,'font-weight: bold;','')}" value=", {!pos.asset.Item_Description__c}" rendered="{!IF(pos.asset.Item_Description__c != '', true, false)}"/>
                        <!-- Display installation date if there is one... -->
                        <apex:outputText style="{!IF(pos.currentNode,'font-weight: bold;','')}" value=", Installed {0,date,short}" rendered="{!IF(NOT(ISBLANK(pos.asset.InstallDate)), true, false)}">
                            <apex:param value="{!pos.asset.InstallDate}"/>
                        </apex:outputText>
                        <!-- ***OR*** indicate that the field is missing -->
                        <mark><apex:outputText style="{!IF(pos.currentNode,'font-weight: bold;','')}" value=", Installation date *UNKNOWN*" rendered="{!IF(ISBLANK(pos.asset.InstallDate), true, false)}"/></mark>
            
                        <!-- Display the Date removed if there is one... -->
                        <mark><apex:outputText style="{!IF(pos.currentNode,'font-weight: bold;','')}" value=", Removed {0,date,short}" rendered="{!IF(NOT(ISBLANK(pos.asset.Date_Removed__c)), true, false)}">
                            <apex:param value="{!pos.asset.Date_Removed__c}"/>
                        </apex:outputText></mark>
            
                        <!-- Stop -->
                        </span>
                        <div> </div>
                        <apex:outputText rendered="{!IF(OR(pos.nodeType=='child_end',pos.nodeType=='child'),false,true)}">
                            <div id='{!pos.nodeId}'></div>
                        </apex:outputText>
                        <apex:outputText rendered="{!IF(OR(pos.nodeType=='child_end',pos.nodeType=='child'),true,false)}">
                            <div id='{!pos.nodeId}'><apex:image url="/s.gif" alt="" width="1" height="1"/></div>
                        </apex:outputText>
                        <apex:repeat value="{!pos.closeFlag}" var="close">
                        </apex:repeat>   
                    </apex:repeat>
                    <br/><br/><br/>
                    </div>
                   <!-- <apex:commandButton value="Change Existing System" onclick="ChangeFamily()" reRender="treeView" disabled="true"/>-->
                    <apex:commandButton value="Cancel" action="{!Cancel}"/>
                </apex:pageBlock>
            </apex:outputPanel>
        </apex:outputPanel>
    </apex:form>
</apex:page>